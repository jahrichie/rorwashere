name: Build and Deploy
#test deploy
on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Log in to GitHub Container Registry
      run: |
        if [ -n "${{ secrets.GHCR_TOKEN }}" ]; then
          echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u "${{ secrets.SERVER_USER }}" --password-stdin
        else
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin
        fi

    - name: Build Docker Image
      run: docker build -t ghcr.io/${{ github.repository }}:latest .

    - name: Push Docker Image to GHCR
      run: docker push ghcr.io/${{ github.repository }}:latest

    - name: SSH into Server and Deploy
      uses: appleboy/ssh-action@v0.1.10
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        envs: GHCR_TOKEN,GITHUB_TOKEN,GITHUB_ACTOR
        script: |
          cd /home/jahrichie/apps/containers/rorwashere
          
          # Login to ghcr.io
          if [ -n "$GHCR_TOKEN" ]; then
            echo "$GHCR_TOKEN" | docker login ghcr.io -u "${{ secrets.SERVER_USER }}" --password-stdin
          else
            echo "$GITHUB_TOKEN" | docker login ghcr.io -u "$GITHUB_ACTOR" --password-stdin
          fi
          
          # Pull latest image
          docker pull ghcr.io/${{ github.repository }}:latest
          
          # Stop and remove existing container if it exists
          docker stop rorwashere || true
          docker rm rorwashere || true
          
          # Ensure Traefik network exists
          docker network inspect proxy >/dev/null 2>&1 || docker network create proxy
          
          # Run the new container with Traefik network and labels (no port mapping - Traefik handles routing)
          docker run -d \
            --name rorwashere \
            --restart unless-stopped \
            --network proxy \
            --label "traefik.enable=true" \
            --label "traefik.http.routers.rorwashere.rule=Host(\`rorwashere.com\`) || Host(\`www.rorwashere.com\`)" \
            --label "traefik.http.routers.rorwashere.entrypoints=websecure" \
            --label "traefik.http.routers.rorwashere.tls=true" \
            --label "traefik.http.routers.rorwashere.tls.certresolver=le" \
            --label "traefik.http.services.rorwashere.loadbalancer.server.port=80" \
            ghcr.io/${{ github.repository }}:latest
          
          # Clean up old images
          docker image prune -f

